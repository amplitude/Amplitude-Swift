name: Dependency Version Check

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  check-dependency-versions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check dependency version consistency
        run: |
          #!/bin/bash
          set -e

          echo "Checking dependency version consistency across Package.swift files, Podspec, and Cartfile..."
          echo ""

          errors=0

          # Find all Package*.swift files in root (excluding .build directory)
          PACKAGE_FILES=$(find . -maxdepth 1 -name "Package*.swift" -type f | sort)

          echo "Found Package manifest files:"
          for f in $PACKAGE_FILES; do
            echo "  - $f"
          done
          echo ""

          # Function to extract version from a Package.swift file
          # Format: .package(url: "https://github.com/amplitude/analytics-connector-ios.git", from: "1.3.0")
          extract_spm_version() {
            local package_name=$1
            local file=$2
            grep -E "github.com/amplitude/${package_name}" "$file" 2>/dev/null | grep -oE "from:[[:space:]]*\"[0-9]+\.[0-9]+\.[0-9]+\"" | grep -oE "[0-9]+\.[0-9]+\.[0-9]+" || echo ""
          }

          # Function to extract version from Cartfile
          # Format: github "amplitude/analytics-connector-ios" ~> 1.3.0
          # Or: binary "https://amplitude.github.io/AmplitudeCore-Swift/Carthage/AmplitudeCore.json" ~> 1.3.1
          extract_carthage_version() {
            local package_name=$1
            grep -E "(github \"amplitude/${package_name}\"|${package_name}.*\.json\")" Cartfile 2>/dev/null | grep -oE "~>[[:space:]]*[0-9]+\.[0-9]+\.[0-9]+" | grep -oE "[0-9]+\.[0-9]+\.[0-9]+" || echo ""
          }

          # Function to extract version from Podspec
          # Format: s.dependency 'AnalyticsConnector', '~> 1.3.0'
          # Or: s.dependency 'AmplitudeCore', '>=1.3.1', '<2.0.0'
          extract_podspec_version() {
            local pod_name=$1
            # Try to match ~> format first
            version=$(grep -E "s\.dependency[[:space:]]+'${pod_name}'" AmplitudeSwift.podspec 2>/dev/null | grep -oE "~>[[:space:]]*[0-9]+\.[0-9]+\.[0-9]+" | grep -oE "[0-9]+\.[0-9]+\.[0-9]+" || echo "")
            if [ -z "$version" ]; then
              # Try to match >= format
              version=$(grep -E "s\.dependency[[:space:]]+'${pod_name}'" AmplitudeSwift.podspec 2>/dev/null | grep -oE ">=[[:space:]]*[0-9]+\.[0-9]+\.[0-9]+" | grep -oE "[0-9]+\.[0-9]+\.[0-9]+" || echo "")
            fi
            echo "$version"
          }

          # Function to check a dependency across all files
          check_dependency() {
            local spm_name=$1
            local carthage_name=$2
            local pod_name=$3
            local dep_errors=0

            echo "Checking: $pod_name"
            echo "----------------------------------------"

            # Get Cartfile and Podspec versions
            carthage_version=$(extract_carthage_version "$carthage_name")
            pod_version=$(extract_podspec_version "$pod_name")

            echo "  Cartfile:      ${carthage_version:-NOT FOUND}"
            echo "  Podspec:       ${pod_version:-NOT FOUND}"

            # Check each Package*.swift file
            local reference_version=""
            for pkg_file in $PACKAGE_FILES; do
              pkg_version=$(extract_spm_version "$spm_name" "$pkg_file")
              pkg_basename=$(basename "$pkg_file")
              echo "  $pkg_basename: ${pkg_version:-NOT FOUND}"

              if [ -n "$pkg_version" ]; then
                if [ -z "$reference_version" ]; then
                  reference_version=$pkg_version
                elif [ "$pkg_version" != "$reference_version" ]; then
                  echo "  ✗ Version mismatch between Package.swift files!"
                  dep_errors=1
                fi
              fi
            done

            # Compare all versions
            if [ -z "$reference_version" ] || [ -z "$carthage_version" ] || [ -z "$pod_version" ]; then
              echo "  ⚠ Warning: Could not find version in all files"
            elif [ "$reference_version" != "$carthage_version" ] || [ "$carthage_version" != "$pod_version" ]; then
              echo "  ✗ Version mismatch between Package.swift, Cartfile, and Podspec!"
              dep_errors=1
            elif [ $dep_errors -eq 0 ]; then
              echo "  ✓ All versions match: $reference_version"
            fi
            echo ""

            return $dep_errors
          }

          echo "================================================================"
          echo "Dependency Version Report"
          echo "================================================================"
          echo ""

          # Check analytics-connector-ios / AnalyticsConnector
          if ! check_dependency "analytics-connector-ios" "analytics-connector-ios" "AnalyticsConnector"; then
            errors=$((errors + 1))
          fi

          # Check AmplitudeCore-Swift / AmplitudeCore
          if ! check_dependency "AmplitudeCore-Swift" "AmplitudeCore" "AmplitudeCore"; then
            errors=$((errors + 1))
          fi

          echo "================================================================"

          if [ $errors -gt 0 ]; then
            echo "FAILED: Found $errors dependency version mismatch(es)"
            echo ""
            echo "Please ensure the minimum version requirements match across:"
            echo "  - All Package*.swift files (from: \"x.y.z\")"
            echo "  - Cartfile (~> x.y.z)"
            echo "  - AmplitudeSwift.podspec (~> x.y.z or >=x.y.z)"
            exit 1
          else
            echo "SUCCESS: All dependency versions are consistent"
          fi
